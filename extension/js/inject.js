const i={info:(r,e=null)=>{console.log(`[Tel Download] ${e?e+": ":""}${r}`)},error:(r,e=null)=>{console.error(`[Tel Download] ${e?e+": ":""}${r}`)}},L=/^bytes (\d+)-(\d+)\/(\d+)$/;async function u(r,e="",d,n,v,y){let h=[],l=0,a=null,g="mp4",o=v||"";if(!o)try{const c=r.split("/").pop();if(c){const s=decodeURIComponent(c);o=JSON.parse(s).fileName||""}}catch(t){console.error("文件名解析失败:",t),o="video"}i.info("URL: "+r,o);const b=()=>{fetch(r,{method:"GET",headers:{Range:`bytes=${l}-`}}).then(async t=>{var m;if(![200,206].includes(t.status))throw new Error("Non 200/206 response was received: "+t.status);g=(((m=t.headers.get("Content-Type"))==null?void 0:m.split(";")[0])||"").split("/")[1]||g;const s=o.indexOf(".");o=(s!==-1?o.substring(0,s+1):o+".")+g;const f=t.headers.get("Content-Range");if(!f)throw new Error("Content-Range header missing");const w=f.match(L);if(!w)throw new Error("Content-Range format error");const E=parseInt(w[1],10),R=parseInt(w[2],10),p=parseInt(w[3],10);if(E!==l)throw new Error("Gap detected between responses.");if(a!==null&&p!==a)throw new Error("Total size differs");if(l=R+1,a=p,i.info(`Get response: ${t.headers.get("Content-Length")} bytes data from ${f}`,o),i.info(`Progress: ${(100*l/a).toFixed(0)}%`,o),e!==""){const C=new CustomEvent(e+"video_download_progress",{detail:{video_id:e,progress:(100*l/a).toFixed(0),page:d,download_id:n,task_id:y}});document.dispatchEvent(C)}return t.blob()}).then(t=>{h.push(t)}).then(()=>{if(a===null)throw new Error("_total_size is NULL");l<a?b():_()}).catch(t=>{i.error(t,o)})},_=async()=>{i.info("Finish downloading blobs",o),i.info("Concatenating blobs and downloading...",o);const t=new Blob(h,{type:"video/mp4"}),c=window.URL.createObjectURL(t);i.info("Final blob size: "+t.size+" bytes",o);const s=document.createElement("a");document.body.appendChild(s),s.href=c,s.download=o,s.click(),document.body.removeChild(s),window.URL.revokeObjectURL(c),i.info("Download triggered",o)};b()}window.addEventListener("message",r=>{const e=r.data;if(e&&typeof e=="object"){if(e.type==="single")u(e.video_src.video_url,e.video_src.video_id,e.video_src.page,e.video_src.download_id,e.video_src.fileName,e.video_src.taskId);else if(e.type==="batch"){const d=e.video_src;for(let n=0;n<d.length;n++)u(d[n].video_url,d[n].video_id,d[n].page,d[n].download_id,d[n].fileName,d[n].taskId)}}});
//# sourceMappingURL=inject.js.map
